---
- name: Ensure running on Arch Linux
  ansible.builtin.assert:
    that:
      - ansible_facts['os_family'] == "Archlinux"
    fail_msg: "This role only supports Arch Linux"
# --------------------------------------------------
# Pacman packages
# --------------------------------------------------
- name: Define pacman package groups
  ansible.builtin.set_fact:
    pacman_package_groups:
      - "{{ pkgs | default([]) }}"
      - "{{ pkgs_dev | default([]) }}"
      - "{{ hyprland_pkgs | default([]) }}"
      - "{{ office_pkgs | default([]) }}"
      - "{{ uni_pkgs | default([]) }}"
- name: Install pacman packages (skip missing)
  community.general.pacman:
    name: "{{ item }}"
    state: present
    update_cache: true
  loop: "{{ pacman_package_groups | flatten | unique }}"
  loop_control:
    label: "{{ item }}"
  failed_when: false
# --------------------------------------------------
# AUR packages
# --------------------------------------------------
- name: Define AUR package groups
  ansible.builtin.set_fact:
    aur_package_groups:
      - "{{ aur_pkgs | default([]) }}"
      - "{{ aur_pkgs_dev | default([]) }}"
      - "{{ hyprland_aur_pkgs | default([]) }}"
      - "{{ office_aur_pkgs | default([]) }}"
      - "{{ uni_aur_pkgs | default([]) }}"
- name: Install AUR packages with paru (skip missing)
  ansible.builtin.command:
    cmd: >
      paru -S --needed --noconfirm {{ item }}

  loop: "{{ aur_package_groups | flatten | unique }}"
  loop_control:
    label: "{{ item }}"
  register: aur_install
  failed_when: false
  changed_when: "'there is nothing to do' not in aur_install.stdout"
# --------------------------------------------------
# Optional summary (useful for debugging)
# --------------------------------------------------
- name: Show failed AUR installs (if any)
  ansible.builtin.debug:
    msg: "Failed to install AUR package: {{ item.item }}"
  loop: "{{ aur_install.results | selectattr('rc', 'ne', 0) | list }}"
  when: aur_install is defined
