# roles/user.dotfiles/tasks/main.yml
- name: Ensure user home exists
  ansible.builtin.file:
    path: "{{ dotfiles_home }}"
    state: directory
    owner: "{{ dotfiles_user }}"
    group: "{{ dotfiles_user }}"
    mode: '0755'
- name: Ensure ~/.config exists
  when: dotfiles_ensure_config_dir | bool
  ansible.builtin.file:
    path: "{{ dotfiles_home }}/.config"
    state: directory
    owner: "{{ dotfiles_user }}"
    group: "{{ dotfiles_user }}"
    mode: '0755'
# ────────────────────────────────────────────────
#   Shell rc files (in home)
# ────────────────────────────────────────────────
- name: Link shell configuration files
  ansible.builtin.file:
    src: "{{ role_path }}/files/{{ dotfiles_src_root }}/{{ item.1 }}"
    dest: "{{ dotfiles_home }}/{{ item.1 | basename }}"
    state: link
    force: "{{ dotfiles_force_overwrite | bool }}"
    owner: "{{ dotfiles_user }}"
    group: "{{ dotfiles_user }}"
  loop: "{{ dotfiles_shells | subelements(dotfiles_shell_files, skip_missing=True) }}"
  loop_control:
    label: "{{ item.1 }}  →  ~/.{{ item.1 | basename }}"
# ────────────────────────────────────────────────
#   ~/.config entries (link files **and** folders)
# ────────────────────────────────────────────────
- name: Link .config entries (files + whole folders)
  ansible.builtin.file:
    src: "{{ role_path }}/files/{{ dotfiles_src_root }}/.config/{{ item }}"
    dest: "{{ dotfiles_home }}/.config/{{ item }}"
    state: link
    force: "{{ dotfiles_force_overwrite | bool }}"
    follow: false
    owner: "{{ dotfiles_user }}"
    group: "{{ dotfiles_user }}"
  loop: "{{ dotfiles_config_entries }}"
  loop_control:
    label: "{{ item }}  →  ~/.config/{{ item }}"
# Optional: remove broken symlinks (cleanup)
- name: Remove broken symlinks in home
  when: dotfiles_force_overwrite | bool
  ansible.builtin.find:
    paths: "{{ dotfiles_home }}"
    depth: 1
    file_type: link
    excludes: "{{ dotfiles_shell_files.values() | flatten | map('basename') | list }}"
    patterns: ".*"
  register: broken_links_find
  changed_when: false
- name: Clean broken dotfile symlinks
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ broken_links_find.files | default([]) }}"
  when: broken_links_find.matched > 0
---
- name: Symlink the bin directory dotfiles
  ansible.builtin.shell: stow -d {{ ansible_facts.env.HOME }}/dotfiles/home -t {{ ansible_facts.env.HOME }} {{ item }}
  loop:
    - bin
    - shell


- name: Symlink configuration dotfiles with stow
  ansible.builtin.command:
    cmd: stow --restow --target "{{ ansible_facts.env.HOME }}/.config" configuration
    chdir: "{{ ansible_facts.env.HOME }}/dotfiles/home/"
  # loop:
  #   - bat
  #   - dunst
  #   - environment.d
  #   - fish
  #   - fastfetch
  #   - hypr
  #   - nvim
  #   - nvim-kickstart
  #   - theming
  #   - waybar
  #   - yazi
  #   - walker
